#!/bin/bash

echo "========================================================"
echo "   ğŸš€ V37 æš´åŠ›å¼ºåˆ¶å¯åŠ¨ (Uvicorn ç›´è¿æ¨¡å¼)"
echo "========================================================"

# 1. ç¡®ä¿ç¯å¢ƒç›®å½•æ­£ç¡®
cd /www/wwwroot/v9_upgrade || exit

# 2. ç‹ ç‹ åœ°æ€æ‰æ‰€æœ‰æ—§è¿›ç¨‹
echo ">> [1/3] æ¸…ç†æ—§è¿›ç¨‹..."
pkill -9 -f main.py
pkill -9 -f cloud_sentinel.py
pkill -9 -f uvicorn
sleep 1

# 3. ä½¿ç”¨ Uvicorn å¼ºåˆ¶å¯åŠ¨ (ç»•è¿‡ main.py å†…éƒ¨çš„å¯åŠ¨ä»£ç )
# --host 0.0.0.0: å…è®¸å¤–ç½‘è®¿é—®
# --port 9000: å¼ºåˆ¶æŒ‡å®š 9000 ç«¯å£
# --log-level info: å¼ºåˆ¶å¼€å¯æ—¥å¿—ï¼Œä¸å†å“‘å·´
echo ">> [2/3] å¼ºåˆ¶å¯åŠ¨ä¸»ç¨‹åº (Port 9000)..."
nohup ./venv/bin/uvicorn main:app --host 0.0.0.0 --port 9000 --log-level info > main_run.log 2>&1 &
sleep 3

# 4. å¯åŠ¨å“¨å…µ
echo ">> [3/3] å¯åŠ¨å“¨å…µ..."
nohup ./venv/bin/python cloud_sentinel.py > sentinel.out 2>&1 &

# 5. éªŒè¯ä¸æ˜¾å½±
echo "--------------------------------------------------------"
echo "ğŸ” æ£€æŸ¥ç«¯å£å ç”¨:"
netstat -tulpn | grep 9000
echo "--------------------------------------------------------"

# æµ‹è¯•æ¥å£
code=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:9000/api/watchlist)

if [ "$code" == "200" ]; then 
    echo "ğŸ‰ğŸ‰ğŸ‰ æˆåŠŸäº†ï¼æ¥å£å·²é€š (HTTP 200)"
    echo "âœ… ç¨‹åºå·²åœ¨ 9000 ç«¯å£å¼ºåˆ¶è¿è¡Œã€‚"
else 
    echo "âŒ ä¾ç„¶å¼‚å¸¸ ($code)ã€‚æ­£åœ¨æ‰“å°å¯åŠ¨æ—¥å¿—..."
    echo "ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä¸»ç¨‹åºæ—¥å¿— ğŸ‘‡ğŸ‘‡ğŸ‘‡"
    tail -n 20 main_run.log
fi
